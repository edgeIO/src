version: "2.4"

services:

  mqtt:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.6
        ipv6_address: 2001:db8:b::6
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0

  mongo_cluster: 
    networks:
      cluster_net:
        ipv4_address: 192.168.129.5
        ipv6_address: 2001:db8:b::5
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0
    command: mongod --port 10107 --ipv6

  mongo_clusternet: 
    networks:
      cluster_net:
        ipv4_address: 192.168.129.4
        ipv6_address: 2001:db8:b::4
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0
    command: mongod --port 10108 --ipv6
  
  cluster_service_manager:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.3
        ipv6_address: 2001:db8:b::3
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0
    environment:
      - MQTT_BROKER_URL=[2001:db8:b::6]
      - SYSTEM_MANAGER_URL=[2001:db8:b::2]
      - CLUSTER_MONGO_URL=[2001:db8:b::4]

  cluster_manager:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.2
        ipv6_address: 2001:db8:b::2
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0
    environment:
      - CLUSTER_SERVICE_MANAGER_ADDR=[2001:db8:b::3]
      - CLUSTER_MONGO_URL=[2001:db8:b::5]
      - CLUSTER_SCHEDULER_URL=[2001:db8:b::7]
      - MQTT_BROKER_URL=[2001:db8:b::6]

  cluster_scheduler:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.7
        ipv6_address: 2001:db8:b::7
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0
    environment:
      - CLUSTER_MANAGER_URL=[2001:db8:b::2]
      - CLUSTER_MONGO_URL=[2001:db8:b::5]
  
  cluster_redis:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.8
        ipv6_address: 2001:db8:b::8
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0

  prometheus:
    networks:
      cluster_net:
        ipv4_address: 192.168.129.9
        ipv6_address: 2001:db8:b::9
    #sysctls:
    # - net.ipv6.conf.all.disable_ipv6=0


networks:
  cluster_net:
    name: cluster_net
    enable_ipv6: true
    driver: bridge
    #driver_opts:
    #com.docker.network.enable_ipv6: "true"
    ipam:
      config:
        - subnet: 2001:db8:b::/64
          gateway: 2001:db8:b::1
        - subnet: 192.168.129.0/24
          gateway: 192.168.129.1
